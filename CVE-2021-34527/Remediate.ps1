function Test-RegistryKeyValue {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]
        $Path,

        [Parameter(Mandatory = $true)]
        [string]
        $Name
    )

    if ( -not (Test-Path -Path $Path -PathType Container) ) {
        return $false
    }

    $properties = Get-ItemProperty -Path $Path 
    if ( -not $properties ) {
        return $false
    }

    $member = Get-Member -InputObject $properties -Name $Name
    if ( $member ) {
        return $true
    }
    else {
        return $false
    }

}

$key = Test-RegistryKeyValue "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -Name "RegisterSpoolerRemoteRpcEndPoint"
try {
    if ($key) {
        $tag = Get-ItemPropertyValue -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -Name "RegisterSpoolerRemoteRpcEndPoint" -ErrorAction Stop
        if ($tag -eq "2") {
            write-host "Incoming RPC Connections are already disabled"
            exit 0 
        }
        else { 
            Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -Name "RegisterSpoolerRemoteRpcEndPoint" -value 2 -ErrorAction Stop
            Write-Host "Updated RegKey to value 2"
            exit 0
        }
    }
    else {
        $keypath = test-path "registry::HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers"
        $spooler = Get-Service "Spooler"
        if ($keypath) {
            New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -Name "RegisterSpoolerRemoteRpcEndPoint" -PropertyType DWord -Value 2 -ErrorAction Stop
            if ($spooler.status -eq "Running") {
                Restart-Service 'Spooler' 
            }
            Write-Host "Created registry key to disable incoming RPC connections to Print Spooler"
            exit 0
        }
        else {
            New-Item "registry::HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers" -ErrorAction Stop
            write-host "Printers Reg Key created, creating Value now"
            New-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers' -Name "RegisterSpoolerRemoteRpcEndPoint" -PropertyType DWord -Value 2 -ErrorAction Stop
            if ($spooler.status -eq "Running") {
                Restart-Service 'Spooler' 
            }
            write-host "Key Created and Value set to 2"
            exit 0
        }
    }
}
catch {
    $errMsg = $_.Exception.Message
    Write-host $errMsg
    exit 1
}
